---

title: HephaestusModel


keywords: fastai
sidebar: home_sidebar

summary: "Encapsulates NMT operations on AbstractMethods."
description: "Encapsulates NMT operations on AbstractMethods."
nb_path: "nbs\04_HephaestusModel.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs\04_HephaestusModel.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="HephaestusModel" class="doc_header"><code>class</code> <code>HephaestusModel</code><a href="https://github.com/WM-SEMERU/hephaestus/tree/main/hephaestus/HephaestusModel.py#L21" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>HephaestusModel</code>(<strong><code>modelDir</code></strong>:<code>str</code>)</p>
</blockquote>
<p>The <a href="/hephaestus/HephaestusModel.html"><code>HephaestusModel</code></a> is the means through which buggy AbstractMethods are translated into fixed ones. Each
<a href="/hephaestus/HephaestusModel.html"><code>HephaestusModel</code></a> occupies a directory which contains stored models, vocabularies, and configuration files.</p>
<p>Required args:</p>
<ul>
<li><code>modelDir</code>: The directory which stores files pertaining to the model. You can use a directory which already
contains the necessary files (previously generated from a different <a href="/hephaestus/HephaestusModel.html"><code>HephaestusModel</code></a>), in which case the
model will not have to be trained again. If you provide a directory that does not exist, the <code>HephaestsuModel</code>
will attempt to create it.</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="HephaestusModel.train" class="doc_header"><code>HephaestusModel.train</code><a href="https://github.com/WM-SEMERU/hephaestus/tree/main/hephaestus/HephaestusModel.py#L50" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>HephaestusModel.train</code>(<strong><code>trainSource</code></strong>:<code>str</code>, <strong><code>trainTarget</code></strong>:<code>str</code>, <strong><code>validSource</code></strong>:<code>str</code>, <strong><code>validTarget</code></strong>:<code>str</code>, <strong><code>vocabSamples</code></strong>:<code>int</code>=<em><code>10000</code></em>, <strong><code>numGPUs</code></strong>:<code>int</code>=<em><code>1</code></em>, <strong><code>trainSteps</code></strong>:<code>int</code>=<em><code>1000</code></em>, <strong><code>validSteps</code></strong>:<code>int</code>=<em><code>None</code></em>, <strong><code>saveCheckpointSteps</code></strong>:<code>int</code>=<em><code>None</code></em>)</p>
</blockquote>
<p>Trains the model with the given parameters. Files containing AbstractMethods should have one per line with
tokens separated by spaces. 'source' files must contain AbstractMethods. 'target' files may contain
AbstractMethods or EditOperations.</p>
<p>As the training progesses, checkpoint model files are created which follow the format <code>model_step_#.pt</code>, where
<code>#</code> corresponds to the training step number. Once training is complete, the finalized model is outputted to
<code>model_final.pt</code>.</p>
<p>Required args:</p>
<ul>
<li><code>trainSource</code>: File name contatining training source data, must be buggy AbstractMethods.</li>
<li><code>trainTarget</code>: File name contatining training target data, can be fixed AbstractMethods or EditOperations
describing buggy -&gt; fixed.</li>
<li><code>validSource</code>: File name contatining validation source data, must be buggy AbstractMethods.</li>
<li><code>validTarget</code>: File name contatining validation target data, must be the same type of data provided in
<code>trainTarget</code>.</li>
</ul>
<p>Optional args:</p>
<ul>
<li><code>vocabSamples</code>: Number of transformed samples per corpus to use when building vocabulary. Defaults to 10000.</li>
<li><code>numGPUs</code>: Number of GPUs to use concurrently during training. If set to 0, then the CPU is used. Defaults to
1.</li>
<li><code>trainSteps</code>: Number of training steps to go through. Defaults to 1000.</li>
<li><code>validSteps</code>: Number of training steps after which each validation occurs; e.g. if <code>trainSteps</code> is 1000 and
<code>validSteps</code> is 500, then validation will occur after training steps 500 and 1000. Defaults to
<code>trainSteps</code> / 2.</li>
<li><code>saveCheckpointSteps</code>: Number of training steps after which model checkpoints are saved; e.g. if <code>trainSteps</code>
is 1000 and 'saveCheckpointSteps' is 500, then the model will be saved in after training steps 5000 and 1000.
Defaults to <code>trainSteps</code> / 2.</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="HephaestusModel.translate" class="doc_header"><code>HephaestusModel.translate</code><a href="https://github.com/WM-SEMERU/hephaestus/tree/main/hephaestus/HephaestusModel.py#L132" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>HephaestusModel.translate</code>(<strong><code>buggy</code></strong>:<code>Union</code>[<code>str</code>, <a href="/hephaestus/AbstractMethod.html"><code>AbstractMethod</code></a>, <code>List</code>[<a href="/hephaestus/AbstractMethod.html"><code>AbstractMethod</code></a>]], <strong><code>modelFile</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>applyEditOperations</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>
<p>Translates the given <code>buggy</code> AbstractMethods into supposedly fixed AbstractMethods, writes them to
<code>&lt;model_directory&gt;/output.txt</code>, and then returns them. Depending on what type of value is passed to
<code>buggy</code>, the return value of this method changes according to the following:</p>
<table>
<thead><tr>
<th style="text-align:left"><code>buggy</code> type</th>
<th style="text-align:left">Return type</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>str</code> (a file)</td>
<td style="text-align:left"><code>List[AbstractMethod]</code></td>
</tr>
<tr>
<td style="text-align:left"><a href="/hephaestus/AbstractMethod.html"><code>AbstractMethod</code></a></td>
<td style="text-align:left"><a href="/hephaestus/AbstractMethod.html"><code>AbstractMethod</code></a></td>
</tr>
<tr>
<td style="text-align:left"><code>List[AbstractMethod]</code></td>
<td style="text-align:left"><code>List[AbstractMethod]</code></td>
</tr>
</tbody>
</table>
<p>Optional args:</p>
<ul>
<li><code>modelFile</code>: A <code>.pt</code> file which is used for translation instead of the default <code>model_final.pt</code></li>
<li><code>applyEditOperations</code>: When set to True, the model output is interpreted as EditOperations -- a
postprocessing stage occurs where the outputted EditOperations are applied to the inputted
AbstractMethods. When set to False, the raw output is interpreted as AbstractMethods and returned
without a postprocessing stage. If the model was trained with EditOperations, <code>applyEditOperations</code>
should be True; if the model was trained with just AbstractMethods as in for the control group,
then this should be False. Defaults to True.</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Example-Usage">Example Usage<a class="anchor-link" href="#Example-Usage"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">HephaestusModel</span><span class="p">(</span><span class="s2">&quot;test_model&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
    <span class="s2">&quot;../data/small/train_buggy.txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;../data/small/train_fixed.txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;../data/small/valid_buggy.txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;../data/small/valid_fixed.txt&quot;</span><span class="p">,</span>
    <span class="n">numGPUs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">trainSteps</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
    <span class="n">validSteps</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">saveCheckpointSteps</span> <span class="o">=</span> <span class="mi">250</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary data-open="Hide Output" data-close="Show Output"></summary>
        <summary></summary>
        
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[2021-04-09 15:43:01,600 INFO] Counter vocab from 10000 samples.
[2021-04-09 15:43:01,601 INFO] Build vocab on 10000 transformed examples/corpus.
[2021-04-09 15:43:01,623 INFO] corpus_1&#39;s transforms: TransformPipe()
[2021-04-09 15:43:01,633 INFO] Loading ParallelCorpus(../data/small/train_buggy.txt, ../data/small/train_fixed.txt, align=None)...
[2021-04-09 15:43:02,403 INFO] Counters src:411
[2021-04-09 15:43:02,404 INFO] Counters tgt:403
[2021-04-09 15:43:02,435 WARNING] path test_model/save_data.vocab.src exists, may overwrite...
[2021-04-09 15:43:02,465 WARNING] path test_model/save_data.vocab.tgt exists, may overwrite...
[2021-04-09 15:43:05,550 INFO] Parsed 2 corpora from -data.
[2021-04-09 15:43:05,725 INFO] Get special vocabs from Transforms: {&#39;src&#39;: set(), &#39;tgt&#39;: set()}.
[2021-04-09 15:43:05,726 INFO] Loading vocab from text file...
[2021-04-09 15:43:05,726 INFO] Loading src vocabulary from test_model/save_data.vocab.src
[2021-04-09 15:43:05,900 INFO] Loaded src vocab has 411 tokens.
[2021-04-09 15:43:05,900 INFO] Loading tgt vocabulary from test_model/save_data.vocab.tgt
[2021-04-09 15:43:05,935 INFO] Loaded tgt vocab has 403 tokens.
[2021-04-09 15:43:05,935 INFO] Building fields with vocab in counters...
[2021-04-09 15:43:05,936 INFO]  * tgt vocab size: 407.
[2021-04-09 15:43:05,937 INFO]  * src vocab size: 413.
[2021-04-09 15:43:05,938 INFO]  * src vocab size = 413
[2021-04-09 15:43:05,938 INFO]  * tgt vocab size = 407
[2021-04-09 15:43:05,938 INFO] Building model...
[2021-04-09 15:43:06,693 INFO] NMTModel(
  (encoder): RNNEncoder(
    (embeddings): Embeddings(
      (make_embedding): Sequential(
        (emb_luts): Elementwise(
          (0): Embedding(413, 500, padding_idx=1)
        )
      )
    )
    (rnn): LSTM(500, 500, num_layers=2, dropout=0.3)
  )
  (decoder): InputFeedRNNDecoder(
    (embeddings): Embeddings(
      (make_embedding): Sequential(
        (emb_luts): Elementwise(
          (0): Embedding(407, 500, padding_idx=1)
        )
      )
    )
    (dropout): Dropout(p=0.3, inplace=False)
    (rnn): StackedLSTM(
      (dropout): Dropout(p=0.3, inplace=False)
      (layers): ModuleList(
        (0): LSTMCell(1000, 500)
        (1): LSTMCell(500, 500)
      )
    )
    (attn): GlobalAttention(
      (linear_in): Linear(in_features=500, out_features=500, bias=False)
      (linear_out): Linear(in_features=1000, out_features=500, bias=False)
    )
  )
  (generator): Sequential(
    (0): Linear(in_features=500, out_features=407, bias=True)
    (1): Cast()
    (2): LogSoftmax(dim=-1)
  )
)
[2021-04-09 15:43:06,694 INFO] encoder: 4214500
[2021-04-09 15:43:06,694 INFO] decoder: 6165407
[2021-04-09 15:43:06,694 INFO] * number of parameters: 10379907
[2021-04-09 15:43:06,707 INFO] Starting training on CPU, could be very slow
[2021-04-09 15:43:06,707 INFO] Start training loop and validate every 100 steps...
[2021-04-09 15:43:06,707 INFO] corpus_1&#39;s transforms: TransformPipe()
[2021-04-09 15:43:06,724 INFO] Loading ParallelCorpus(../data/small/train_buggy.txt, ../data/small/train_fixed.txt, align=None)...
[2021-04-09 15:45:35,130 INFO] Step 50/  500; acc:  11.79; ppl: 1690.73; xent: 7.43; lr: 1.00000; 674/637 tok/s;    148 sec
[2021-04-09 15:47:57,354 INFO] Step 100/  500; acc:  12.99; ppl: 783.34; xent: 6.66; lr: 1.00000; 719/678 tok/s;    291 sec
[2021-04-09 15:47:57,354 INFO] valid&#39;s transforms: TransformPipe()
[2021-04-09 15:47:57,358 INFO] Loading ParallelCorpus(../data/small/valid_buggy.txt, ../data/small/valid_fixed.txt, align=None)...
[2021-04-09 15:49:32,115 INFO] Validation perplexity: 62.9022
[2021-04-09 15:49:32,115 INFO] Validation accuracy: 9.56364
[2021-04-09 15:51:51,474 INFO] Step 150/  500; acc:  19.41; ppl: 63.30; xent: 4.15; lr: 1.00000; 426/406 tok/s;    525 sec
[2021-04-09 15:54:10,095 INFO] Step 200/  500; acc:  33.56; ppl: 21.54; xent: 3.07; lr: 1.00000; 733/693 tok/s;    663 sec
[2021-04-09 15:54:10,098 INFO] Loading ParallelCorpus(../data/small/valid_buggy.txt, ../data/small/valid_fixed.txt, align=None)...
[2021-04-09 15:55:43,957 INFO] Validation perplexity: 14.0887
[2021-04-09 15:55:43,958 INFO] Validation accuracy: 40.9356
[2021-04-09 15:58:05,429 INFO] Step 250/  500; acc:  43.34; ppl: 12.01; xent: 2.49; lr: 1.00000; 434/408 tok/s;    899 sec
[2021-04-09 15:58:05,433 INFO] Saving checkpoint test_model/model_step_250.pt
[2021-04-09 16:00:35,173 INFO] Step 300/  500; acc:  47.41; ppl:  9.06; xent: 2.20; lr: 1.00000; 674/642 tok/s;   1048 sec
[2021-04-09 16:00:35,177 INFO] Loading ParallelCorpus(../data/small/valid_buggy.txt, ../data/small/valid_fixed.txt, align=None)...
[2021-04-09 16:02:14,999 INFO] Validation perplexity: 11.6772
[2021-04-09 16:02:14,999 INFO] Validation accuracy: 44.911
[2021-04-09 16:04:50,386 INFO] Step 350/  500; acc:  51.08; ppl:  7.66; xent: 2.04; lr: 1.00000; 415/388 tok/s;   1304 sec
[2021-04-09 16:07:20,581 INFO] Step 400/  500; acc:  54.68; ppl:  6.53; xent: 1.88; lr: 1.00000; 660/624 tok/s;   1454 sec
[2021-04-09 16:07:20,585 INFO] Loading ParallelCorpus(../data/small/valid_buggy.txt, ../data/small/valid_fixed.txt, align=None)...
[2021-04-09 16:08:54,989 INFO] Validation perplexity: 6.27018
[2021-04-09 16:08:54,989 INFO] Validation accuracy: 59.0065
[2021-04-09 16:11:28,483 INFO] Step 450/  500; acc:  56.07; ppl:  5.92; xent: 1.78; lr: 1.00000; 417/392 tok/s;   1702 sec
[2021-04-09 16:13:59,300 INFO] Step 500/  500; acc:  57.93; ppl:  5.42; xent: 1.69; lr: 1.00000; 659/626 tok/s;   1853 sec
[2021-04-09 16:13:59,304 INFO] Loading ParallelCorpus(../data/small/valid_buggy.txt, ../data/small/valid_fixed.txt, align=None)...
[2021-04-09 16:15:53,970 INFO] Validation perplexity: 4.64709
[2021-04-09 16:15:53,970 INFO] Validation accuracy: 63.2672
[2021-04-09 16:15:53,975 INFO] Saving checkpoint test_model/model_step_500.pt
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">buggyMethod</span> <span class="o">=</span> <span class="n">readAbstractMethodsFromFile</span><span class="p">(</span><span class="s2">&quot;../data/small/test_buggy.txt&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">buggyMethod</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>private TYPE_1 getType ( TYPE_2 VAR_1 ) { TYPE_3 VAR_2 = new TYPE_3 ( STRING_1 ) ; return new TYPE_1 ( VAR_2 , VAR_2 ) ; }</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fixedMethod</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">buggyMethod</span><span class="p">,</span> <span class="n">applyEditOperations</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">fixedMethod</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[2021-04-09 16:21:10,149 INFO] Translating shard 0.
[2021-04-09 16:21:10,276 INFO] PRED AVG SCORE: -0.5357, PRED PPL: 1.7087
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>private TYPE_1 METHOD_1 ( ) { return VAR_1 . METHOD_2 ( ) ) ; }</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">actualFixedMethod</span> <span class="o">=</span> <span class="n">readAbstractMethodsFromFile</span><span class="p">(</span><span class="s2">&quot;../data/small/test_fixed.txt&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">actualFixedMethod</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>private TYPE_1 getType ( TYPE_2 VAR_1 ) { TYPE_3 VAR_2 = new TYPE_3 ( STRING_1 ) ; return new TYPE_1 ( VAR_2 , VAR_2 , this , VAR_1 ) ; }</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

